module.exports=grammar({
    name:"cppl",
    word:$=>$.word,
    extras:$=>[
        $.comment,
        $.doc_comment,
        /[\r\t\n ]/,
    ],
    externals:$=>[
        $.raw_string,
    ],
    rules:{
        source_file:$=>repeat($._statement),
        _statement:$=>choice(
            $.function,
            $.interface_def,
            seq($.expr,$._statement_end),
            seq($.type_def,$._statement_end),
            seq($.var_decl,$._statement_end),
            seq($.var_assign,$._statement_end),
            seq($.return_stmt,$._statement_end),
            seq($.continue_stmt,$._statement_end),
            "\n",
        ),
        expr:$=>choice(
            $.object_create,
            $.block,
            $.data,
        ),
        object_create:$=>seq(
            "{",
            repeat(seq($.object_field,",",)),
            $.object_field,
            optional(","),
            "}",
        ),
        object_field:$=>choice(
            seq(
                optional($.public),
                optional($.mutable),
                field("name",$.word),
            ),
            seq(
                optional($.public),
                optional($.mutable),
                field("name",$.word),
                "=",
                field("data",$.expr),
            ),
        ),
        data:$=>choice(
            $.float,
            $.number,
            $.char,
            $.string,
            $.true_keyword,
            $.false_keyword,
        ),
        _statement_end:_=>choice(repeat1(";"),"\n"),
        return_stmt:$=>choice(
            seq(
                $.return_keyword,
                optional($.label),
            ),
            seq(
                $.return_keyword,
                optional($.label),
                field("data",$.expr),
            ),
        ),
        continue_stmt:$=>seq(
            $.continue_keyword,
            optional($.label),
        ),
        label:$=>seq(
            "^",
            field("name",$.word),
        ),
        function:$=>seq(
            optional($.public),
            $.fn_keyword,
            field("name",$.word),
            field("parameters",$.parameters),
            optional(seq(":",field("ret_type",$._type))),
            field("block",$.block),
        ),
        anon_function:$=>seq(
            $.fn_keyword,
            field("parameters",$.parameters),
            optional(seq(":",field("ret_type",$._type))),
            field("block",$.block),
        ),
        type_def:$=>seq(
            optional($.public),
            $.type_keyword,
            field("name",$.word),
            optional(field("type_parameters",$.type_parameters)),
            "=",
            $._type,
        ),
        interface_def:$=>seq(
            optional($.public),
            $.interface_keyword,
            field("name",$.word),
            optional(field("type_parameters",$.type_parameters)),
            field("block",$.block),
        ),
        var_decl:$=>choice(
            seq(    // no type
                optional($.public),
                optional($.mutable),
                field("name",$.word),
                ":=",
                field("data",$.expr),
            ),
            seq(    // no type
                optional($.public),
                optional($.mutable),
                field("name",$.word),
                ":",
                field("ty",$._type),
                "=",
                field("data",$.expr),
            ),
        ),
        var_assign:$=>seq(
            field("name",$.word),
            "=",
            field("data",$.expr),
        ),
        block:$=>choice(
            seq("{","}"),
            seq(
                "{",
                repeat($._statement),
                "}",
            ),
        ),
        parameters:$=>choice(
            seq("[","]"),
            seq(
                "[",
                $.this_keyword,
                repeat(seq(",",$.parameter)),
                optional($.var_arg_param),
                "]",
            ),
            seq(
                "[",
                $.mut_keyword,
                $.this_keyword,
                repeat(seq(",",$.parameter)),
                optional($.var_arg_param),
                "]",
            ),
            seq(
                "[",
                repeat(seq($.parameter,",")),
                $.parameter,
                optional($.var_arg_param),
                "]",
            ),
        ),
        var_arg_param:$=>seq(",","...",$.parameter),
        parameter:$=>seq(
            optional($.mut_keyword),
            field("name",$.word),
            ":",
            field("ty",$._type),
        ),
        type_parameters:$=>seq(
            "[",
            repeat(seq($.type_parameter,",")),
            $.type_parameter,
            optional(","),
            "]",
        ),
        type_parameter:$=>seq(
            field("name",$.word),
            ":",
            field("ty",$._type),
        ),
        _type:$=>choice(
            $.composite_type,
            $.union_type,
            $.named_type,
            $.object_type,
            $.builtin_type,
            $.anon_function_sig,
            seq("(",$._type,")"),
        ),
        composite_type:$=>prec.left(2,seq($._type,"+",$._type)),
        union_type:$=>prec.left(3,seq($._type,"|",$._type)),
        anon_function_sig:$=>seq(
            $.fn_keyword,
            field("parameters",$.parameters),
            optional(seq(":",field("ret_type",$._type))),
        ),
        _type_enclosed:$=>choice(
            $.composite_type_enclosed,
            $.union_type_enclosed,
            $.named_type,
            $.object_type,
            $.builtin_type,
            $.anon_function_sig,
            seq("(",$._type_enclosed,")"),
        ),
        composite_type_enclosed:$=>prec.left(2,seq($._type,"+",$._type)),
        union_type_enclosed:$=>prec.left(3,seq($._type,"|",$._type)),
        named_type:$=>choice(
            field("name",$.word),
            seq(field("name",$.word),"(",field("generics",repeat(seq($._type,","))),$._type,")"),
        ),
        object_type:$=>choice(
            seq("{","}"),
            seq(
                "{",
                repeat(seq($.object_type_field,",")),
                $.object_type_field,
                optional(","),
                "}",
            ),
            seq(
                "{",
                repeat(seq($.object_type_field,",")),
                "...",
                "}",
            ),
        ),
        builtin_type:_=>prec(5,choice(
            "Float",
            "DoubleFloat",
            "Byte",
            "Int",
            "Uint",
            "Char",
            "Bool",
            "String",
        )),
        object_type_field:$=>seq(
            optional($.public),
            optional($.mutable),
            field("name",$.word),
            ":",
            field("ty",$._type),
        ),
        public:$=>choice(
            $.pub_keyword,
            seq($.pub_keyword,"(",$.visibility,")"),
        ),
        mutable:$=>choice(
            $.mut_keyword,
            seq($.mut_keyword,"(",$.visibility,")"),
        ),
        visibility:_=>choice(
            "lib",
            "local",
            "full",
        ),

        // # Tokens/Terminals
        // ## Keywords
        fn_keyword:_=>"fn",
        type_keyword:_=>"type",
        interface_keyword:_=>"interface",
        pub_keyword:_=>"pub",
        mut_keyword:_=>"mut",
        impl_keyword:_=>"impl",
        import_keyword:_=>"import",
        for_keyword:_=>"for",
        while_keyword:_=>"while",
        loop_keyword:_=>"loop",
        return_keyword:_=>"return",
        continue_keyword:_=>"continue",
        match_keyword:_=>"match",
        enum_keyword:_=>"enum",
        module_keyword:_=>"module",
        this_keyword:_=>"this",
        true_keyword:_=>"true",
        false_keyword:_=>"false",

        // ## Words, numbers, strings, chars
        word:_=>/[a-zA-Z_][a-zA-Z0-9_]*/,
        string:$=>choice(
            seq("\"",repeat(seq(/[^"\\]*/,$.string_escape)),/[^"\\]*/,"\""),
            $.raw_string,
        ),
        string_escape:_=>choice(
            "\\\\",
            "\\\"",
            "\\n",
            "\\r",
            "\\t",
            "\\0",
            "\\\\",
            /\\u\{[0-9a-fA-F]{1,6}\}/,
            /\\x[0-9a-fA-F]{2}/,
            /[^\\\n]/,
        ),
        number:$=>$._number_sym,
        _number_sym:_=>/[0-9][0-9_]*/,
        float:$=>choice(
            prec(4,seq($._number_sym,".",$._number_sym)),
            prec(3,seq($._number_sym,".")),
            prec(2,seq(".",$._number_sym)),
        ),
        char:_=>choice(
            "'\\\\'",
            "'\"'",
            "'\\n'",
            "'\\r'",
            "'\\t'",
            "'\\0'",
            "'\\\\'",
            /'\\u\{[0-9a-fA-F]{1,6}\}'/,
            /'\\x[0-9a-fA-F]{2}'/,
            /'[^\\\n]'/,
        ),

        // ## Doc comments
        doc_comment:$=>prec(10,choice(
            seq(/\/\/\//,field("body",$.line_comment_body)),
        )),
        line_comment_body:_=>/[^\n]*/,

        // ## Regular comments
        comment:_=>/\/\/[^/][^\n]*/,
    }
});
